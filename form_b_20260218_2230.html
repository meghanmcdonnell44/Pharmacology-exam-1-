<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NCLEX-Style Timed Exam — Form B (Balanced)</title>
<style>
  :root {
    --bg: #0b0f17;
    --panel: #121a29;
    --panel2: #0f1624;
    --text: #e8edf7;
    --muted: #a8b3c7;
    --accent: #5dd6ff;
    --danger: #ff5d7a;
    --ok: #52ffa8;
    --border: rgba(255,255,255,.10);
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, system-ui, sans-serif;
    background: radial-gradient(1200px 700px at 15% 10%, rgba(93,214,255,.12), transparent 60%),
                radial-gradient(900px 600px at 85% 25%, rgba(82,255,168,.10), transparent 65%),
                var(--bg);
    color: var(--text);
  }
  a { color: var(--accent); }
  .wrap {
    max-width: 1200px;
    margin: 0 auto;
    padding: 18px;
  }
  .card {
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border: 1px solid var(--border);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    overflow: hidden;
  }
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 14px 16px;
    background: rgba(0,0,0,.18);
    border-bottom: 1px solid var(--border);
  }
  .title {
    font-weight: 700;
    letter-spacing: .2px;
  }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(18,26,41,.7);
    color: var(--muted);
    font-size: 13px;
    white-space: nowrap;
  }
  .timer {
    font-variant-numeric: tabular-nums;
    color: var(--text);
    font-weight: 700;
  }
  .grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    min-height: 72vh;
  }
  @media (max-width: 900px) {
    .grid { grid-template-columns: 1fr; }
  }
  .sidebar {
    padding: 14px;
    background: rgba(18,26,41,.35);
    border-right: 1px solid var(--border);
  }
  @media (max-width: 900px) {
    .sidebar {
      border-right: 0;
      border-bottom: 1px solid var(--border);
    }
  }
  .qnav {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 8px;
  }
  .qbtn {
    appearance: none;
    border: 1px solid var(--border);
    background: rgba(15,22,36,.6);
    color: var(--text);
    border-radius: 10px;
    padding: 10px 0;
    font-weight: 700;
    cursor: pointer;
    transition: transform .05s ease, background .2s ease, border-color .2s ease;
  }
  .qbtn:hover { transform: translateY(-1px); border-color: rgba(93,214,255,.55); }
  .qbtn.active { background: rgba(93,214,255,.18); border-color: rgba(93,214,255,.65); }
  .qbtn.answered { background: rgba(82,255,168,.12); border-color: rgba(82,255,168,.35); }
  .qbtn.flagged { background: rgba(255,93,122,.14); border-color: rgba(255,93,122,.45); }
  .sidebar .meta {
    margin-top: 14px;
    display: grid;
    gap: 10px;
  }
  .metaRow {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 13px;
    color: var(--muted);
  }
  .main {
    padding: 18px;
  }
  .stem {
    font-size: 18px;
    line-height: 1.35;
    margin: 0 0 14px 0;
  }
  .tag {
    font-size: 12px;
    color: var(--muted);
    border: 1px solid var(--border);
    background: rgba(15,22,36,.55);
    display: inline-block;
    padding: 6px 10px;
    border-radius: 999px;
    margin-bottom: 10px;
  }
  .choices {
    display: grid;
    gap: 10px;
  }
  label.choice {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    padding: 12px 12px;
    background: rgba(15,22,36,.55);
    border: 1px solid var(--border);
    border-radius: 12px;
    cursor: pointer;
  }
  label.choice:hover {
    border-color: rgba(93,214,255,.55);
    background: rgba(15,22,36,.72);
  }
  input[type="radio"], input[type="checkbox"] {
    margin-top: 2px;
    accent-color: var(--accent);
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 16px;
  }
  button.btn {
    appearance: none;
    border: 1px solid var(--border);
    background: rgba(18,26,41,.65);
    color: var(--text);
    border-radius: 12px;
    padding: 10px 12px;
    font-weight: 700;
    cursor: pointer;
  }
  button.btn:hover { border-color: rgba(93,214,255,.55); }
  button.primary {
    background: rgba(93,214,255,.18);
    border-color: rgba(93,214,255,.55);
  }
  button.danger {
    background: rgba(255,93,122,.14);
    border-color: rgba(255,93,122,.55);
  }
  button.ok {
    background: rgba(82,255,168,.12);
    border-color: rgba(82,255,168,.45);
  }
  .note {
    color: var(--muted);
    font-size: 13px;
    line-height: 1.35;
  }
  .startScreen {
    max-width: 860px;
    margin: 30px auto;
    padding: 18px;
  }
  .startScreen h1 {
    margin: 0 0 6px 0;
    font-size: 28px;
  }
  .startScreen ul {
    margin: 10px 0 0 18px;
    color: var(--muted);
    line-height: 1.5;
  }
  .hidden { display: none; }
  .calcBox {
    display: grid;
    gap: 10px;
  }
  .calcBox input {
    width: 240px;
    max-width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(15,22,36,.55);
    color: var(--text);
    font-size: 16px;
  }
  .ordered {
    display: grid;
    gap: 10px;
  }
  .step {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 10px 12px;
    background: rgba(15,22,36,.55);
    border: 1px solid var(--border);
    border-radius: 12px;
  }
  .step .handle {
    width: 26px;
    height: 26px;
    border-radius: 8px;
    border: 1px solid var(--border);
    display: grid;
    place-items: center;
    color: var(--muted);
    font-weight: 700;
  }
  .step .txt {
    flex: 1;
    line-height: 1.3;
  }
  .step .arrows button {
    margin-left: 6px;
    padding: 6px 8px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: rgba(18,26,41,.65);
    color: var(--text);
    cursor: pointer;
  }
  .results h2 {
    margin: 0 0 6px 0;
  }
  .resultItem {
    padding: 12px 12px;
    border: 1px solid var(--border);
    border-radius: 14px;
    background: rgba(15,22,36,.55);
    margin: 10px 0;
  }
  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 800;
    border: 1px solid var(--border);
    margin-right: 8px;
  }
  .badge.ok { color: var(--ok); border-color: rgba(82,255,168,.35); background: rgba(82,255,168,.12); }
  .badge.no { color: var(--danger); border-color: rgba(255,93,122,.45); background: rgba(255,93,122,.14); }
  .rationale {
    color: var(--muted);
    margin-top: 8px;
    line-height: 1.35;
  }
</style>
</head>
<body>
<div id="start" class="wrap startScreen">
  <div class="card">
    <div class="topbar">
      <div class="title">NCLEX-Style Timed Exam - Pain & Pharmacology (50 Questions)</div>
      <div class="pill"><span>Time:</span> <span class="timer">90:00</span></div>
    </div>
    <div style="padding:16px 18px;">
      <h1>NCLEX-Style Timed Exam — Form B (Balanced)</h1>
      <div class="note">
        <ul>
          <li>This exam runs fully in your browser (works well on a Mac).</li>
          <li>Question types include Multiple Choice, Select-All-That-Apply (SATA), Ordered Response, and Calculations.</li>
          <li>Use the sidebar to jump between questions. You can flag questions for review.</li>
          <li>Your progress is saved automatically in this browser.</li>
          <li>When you submit, you'll see your score plus the answer key and rationales.</li>
        </ul>
      </div>
      <div class="controls" style="margin-top:16px;">
        <button class="btn primary" id="startBtn">Start Exam</button>
        <button class="btn" id="resetBtn">Reset Saved Attempt</button>
      </div>
      <div class="note" style="margin-top:10px;">Tip: For best timing accuracy, keep this tab open during the exam.</div>
    </div>
  </div>
</div>

<div id="exam" class="wrap hidden">
  <div class="card">
    <div class="topbar">
      <div class="title" id="headerTitle">Question</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div class="pill"><span>Answered:</span> <span id="answeredCount">0</span>/50</div>
        <div class="pill"><span>Flagged:</span> <span id="flaggedCount">0</span></div>
        <div class="pill"><span>Time Left:</span> <span class="timer" id="timer">90:00</span></div>
      </div>
    </div>

    <div class="grid">
      <div class="sidebar">
        <div class="qnav" id="qnav"></div>
        <div class="meta">
          <div class="metaRow"><span>Current</span><span id="curMeta">1 / 50</span></div>
          <div class="metaRow"><span>Type</span><span id="typeMeta">MC</span></div>
          <div class="metaRow"><span>Status</span><span id="statusMeta">Not answered</span></div>
        </div>
        <div class="controls" style="margin-top:12px;">
          <button class="btn" id="flagBtn">Flag / Unflag</button>
          <button class="btn" id="clearBtn">Clear Answer</button>
          <button class="btn danger" id="submitBtn">Submit Exam</button>
        </div>
      </div>

      <div class="main">
        <div class="tag" id="qTag">Type</div>
        <p class="stem" id="stem"></p>
        <div id="interaction"></div>

        <div class="controls">
          <button class="btn" id="prevBtn">Previous</button>
          <button class="btn primary" id="nextBtn">Next</button>
        </div>
        <div class="note" style="margin-top:10px;">Exam note: Answer key and rationales appear after submission.</div>
      </div>
    </div>
  </div>
</div>

<div id="results" class="wrap hidden">
  <div class="card">
    <div class="topbar">
      <div class="title">Results</div>
      <div class="pill"><span>Score:</span> <span class="timer" id="scoreText">0/50</span></div>
    </div>
    <div class="main results" id="resultsBody"></div>
  </div>
</div>

<script>
const QUESTIONS = [{"id": 1, "type": "mc", "stem": "A client with chronic kidney disease (eGFR 25 mL/min) requests ibuprofen for back pain. Which provider order should the nurse question?", "options": ["Ibuprofen 600 mg PO every 6 hours PRN pain", "Acetaminophen 650 mg PO every 6 hours PRN pain (max daily dose per policy)", "Nonpharmacologic heat/ice per comfort protocol", "Topical lidocaine patch per order"], "answer": "Ibuprofen 600 mg PO every 6 hours PRN pain", "rationale": "First‑generation NSAIDs increase risk for renal impairment and can worsen kidney function; an NSAID order is most concerning in a client with significant renal impairment."}, {"id": 2, "type": "sata", "stem": "A nurse is teaching a client starting tramadol for acute pain. Which instructions should the nurse include? Select all that apply.", "options": ["Avoid driving or operating machinery until you know how the medication affects you.", "Increase fiber/fluid and consider a stool softener to prevent constipation.", "Take the medication with alcohol to enhance pain relief.", "Report slowed breathing or extreme sleepiness immediately.", "Stop the medication abruptly once pain improves to prevent dependence."], "answer": ["Avoid driving or operating machinery until you know how the medication affects you.", "Increase fiber/fluid and consider a stool softener to prevent constipation.", "Report slowed breathing or extreme sleepiness immediately."], "rationale": "Tramadol can cause sedation/dizziness, respiratory depression, and constipation. Alcohol increases CNS/respiratory depression risk. Abrupt stopping is not a teaching point for short-term PRN use; safety and adverse effect monitoring are priorities."}, {"id": 3, "type": "mc", "stem": "A client is prescribed sumatriptan for migraines. Which history finding is most important to report to the provider before administration?", "options": ["Migraine occurs 3 times per month", "Hypertension and coronary artery disease", "Photophobia during migraine attacks", "Nausea with vomiting during migraines"], "answer": "Hypertension and coronary artery disease", "rationale": "Triptans can cause coronary vasoconstriction and are contraindicated/used with extreme caution in cardiovascular disease and uncontrolled hypertension."}, {"id": 4, "type": "mc", "stem": "A client taking gabapentin for neuropathic pain says, “I don’t want this because there’s no therapeutic level drawn.” Which is the best nurse response?", "options": ["Therapeutic levels are only drawn for medications that cause kidney toxicity.", "Gabapentin used for pain does not require a therapeutic serum level; we monitor symptom relief and side effects.", "If no level is drawn, the medication is not safe to take.", "Therapeutic levels are required only for controlled substances."], "answer": "Gabapentin used for pain does not require a therapeutic serum level; we monitor symptom relief and side effects.", "rationale": "Gabapentin (for nerve pain) typically does not require therapeutic drug monitoring; nursing focuses on indication, symptom response, and CNS side effects like dizziness/drowsiness."}, {"id": 5, "type": "mc", "stem": "A postoperative client received IV hydromorphone. Which assessment finding requires the most immediate nursing action?", "options": ["Respiratory rate 8/min and difficult to arouse", "Pruritus and nausea", "Constipation for 2 days", "Pain score decreased from 9/10 to 4/10"], "answer": "Respiratory rate 8/min and difficult to arouse", "rationale": "Opioid‑induced respiratory depression and decreased LOC are life‑threatening and require immediate intervention (airway support, hold opioid, notify provider, consider naloxone per protocol)."}, {"id": 6, "type": "calc", "stem": "Half‑life calculation: A client receives metoprolol tartrate 50 mg. The half‑life is 3 hours. How many mg remain after 12 hours? (Enter a number; no rounding.)", "answer": ["3.125"], "rationale": "Every 3 hours the amount halves: 50 → 25 (3h) → 12.5 (6h) → 6.25 (9h) → 3.125 (12h)."}, {"id": 7, "type": "calc", "stem": "Half‑life calculation: Ibuprofen 200 mg has a half‑life of 2 hours. How many mg remain after 10 hours? (Enter a number; no rounding.)", "answer": ["6.25"], "rationale": "10 hours is five half‑lives (2h each): 200 → 100 → 50 → 25 → 12.5 → 6.25 mg."}, {"id": 8, "type": "mc", "stem": "A nurse is reviewing an order: “Morphine 2 mg IV now PRN severe pain.” Which additional element must be present for a safe PRN order?", "options": ["A stop date only", "An indication (e.g., PRN severe pain)", "A refill number", "A brand name medication"], "answer": "An indication (e.g., PRN severe pain)", "rationale": "PRN medication orders must include a clear indication for use to guide safe administration and evaluation."}, {"id": 9, "type": "sata", "stem": "Which client findings increase risk for drug toxicity due to altered protein binding? Select all that apply.", "options": ["Albumin 2.2 g/dL", "Poor nutrition with low protein intake", "Creatinine within expected range", "Cirrhosis with decreased albumin production", "High albumin level"], "answer": ["Albumin 2.2 g/dL", "Poor nutrition with low protein intake", "Cirrhosis with decreased albumin production"], "rationale": "Low albumin (from liver impairment or poor nutrition) reduces protein binding, increasing free drug and risk of excessive effect/toxicity."}, {"id": 10, "type": "mc", "stem": "A client takes acetaminophen for pain. Which statement by the client indicates correct understanding of a key safety risk?", "options": ["I should take it on an empty stomach for faster absorption.", "It can cause liver damage if I take too much or if I have liver disease.", "It will reduce inflammation better than ibuprofen.", "It increases bleeding risk, so I’ll avoid it with anticoagulants."], "answer": "It can cause liver damage if I take too much or if I have liver disease.", "rationale": "Acetaminophen’s major dose‑related toxicity is hepatotoxicity; it is not a meaningful anti‑inflammatory and does not have the same platelet effects as NSAIDs."}, {"id": 11, "type": "mc", "stem": "A client reports ringing in the ears after taking high doses of aspirin. Which interpretation is most accurate?", "options": ["Expected anticholinergic effect", "Sign of salicylate toxicity", "Sign of opioid withdrawal", "Indicates therapeutic effect reached"], "answer": "Sign of salicylate toxicity", "rationale": "Tinnitus can be an early sign of salicylate (aspirin) toxicity and should be reported."}, {"id": 12, "type": "mc", "stem": "A client with asthma asks for ibuprofen for a fever. Which is the best action?", "options": ["Administer ibuprofen; asthma is unrelated to NSAID use.", "Hold ibuprofen and notify the provider; NSAIDs can be contraindicated in asthma.", "Administer aspirin instead.", "Administer naproxen instead."], "answer": "Hold ibuprofen and notify the provider; NSAIDs can be contraindicated in asthma.", "rationale": "First‑generation NSAIDs can be contraindicated in clients with asthma due to risk of bronchospasm/worsening symptoms."}, {"id": 13, "type": "calc", "stem": "A client has been receiving a maintenance dose of a medication with a half‑life of 6 hours. Approximately how long will it take to reach steady state (plateau)? (Enter hours.)", "answer": ["24"], "rationale": "Steady state is reached after ~4 half‑lives. 4 × 6 hours = 24 hours."}, {"id": 14, "type": "mc", "stem": "A nurse is caring for a client with severe pain. Which opioid is typically dosed in micrograms due to high potency?", "options": ["Morphine", "Hydromorphone", "Fentanyl", "Codeine"], "answer": "Fentanyl", "rationale": "Fentanyl is highly potent and commonly ordered in micrograms, reflecting potency differences across opioids."}, {"id": 15, "type": "sata", "stem": "A nurse is preparing to administer naloxone for suspected opioid overdose. Which findings support this intervention? Select all that apply.", "options": ["Pinpoint pupils", "Respiratory rate 6/min", "Severe hypertension and agitation after recent stimulant use", "Unresponsive to verbal stimuli", "Watery eyes and yawning with normal respirations"], "answer": ["Pinpoint pupils", "Respiratory rate 6/min", "Unresponsive to verbal stimuli"], "rationale": "Opioid overdose commonly presents with miosis, respiratory depression, and decreased LOC. Watery eyes/yawning may indicate withdrawal; hypertension/agitation suggests other causes."}, {"id": 16, "type": "ordered", "stem": "Place the following actions in priority order for a client with suspected opioid overdose. (1 = first, 5 = last)", "steps": ["Assess airway and breathing; apply oxygen as needed.", "Call for help/activate rapid response per facility policy.", "Check responsiveness, pulse, and obtain vital signs.", "Prepare and administer naloxone per protocol.", "Reassess respiratory status and level of consciousness; anticipate repeat dosing and monitor for recurrence."], "answer_order": [3, 2, 1, 4, 5], "rationale": "Initial assessment of responsiveness/vitals occurs immediately, while calling for help and addressing airway/breathing are priorities; naloxone follows confirmation of opioid toxidrome, and reassessment is ongoing."}, {"id": 17, "type": "mc", "stem": "A client with peptic ulcer disease asks which OTC medication is safest for fever. Which is best?", "options": ["Ibuprofen", "Naproxen", "Acetaminophen", "Aspirin"], "answer": "Acetaminophen", "rationale": "NSAIDs increase risk for GI ulceration and bleeding; acetaminophen is preferred for pain/fever when GI bleeding risk is present (within safe dosing limits)."}, {"id": 18, "type": "calc", "stem": "Half‑life calculation: Sumatriptan 20 mg (nasal) has a half‑life of 15 minutes. How many mg remain after 60 minutes? (Enter a number; no rounding.)", "answer": ["1.25"], "rationale": "60 minutes is four half‑lives (15 min each): 20 → 10 → 5 → 2.5 → 1.25 mg."}, {"id": 19, "type": "mc", "stem": "A client has an active migraine with aura and requests the best timing for an abortive medication. Which teaching is correct?", "options": ["Take it only after the headache is at maximum intensity.", "Take it at the first sign of migraine, including aura symptoms.", "Take it daily to prevent future migraines.", "Take it only at bedtime to avoid side effects."], "answer": "Take it at the first sign of migraine, including aura symptoms.", "rationale": "Abortive therapy works best when taken early—at the first sign of migraine (including aura)."}, {"id": 20, "type": "mc", "stem": "A client reports migraines occurring 3 times per week that interfere with ADLs and are not relieved with abortive therapy. Which medication approach is most appropriate?", "options": ["Start a daily preventative medication such as topiramate.", "Increase the frequency of triptan use to daily.", "Avoid medications and use only dark rooms.", "Switch to aspirin daily."], "answer": "Start a daily preventative medication such as topiramate.", "rationale": "Frequent migraines (>2/week) that impair ADLs and are not relieved with acute therapy warrant daily preventative therapy (e.g., topiramate)."}, {"id": 21, "type": "sata", "stem": "The nurse is teaching a client about cyclobenzaprine. Which expected side effects should be included? Select all that apply.", "options": ["Drowsiness", "Muscle weakness", "Dry mouth", "Severe respiratory depression as the most common effect", "Dizziness"], "answer": ["Drowsiness", "Muscle weakness", "Dry mouth", "Dizziness"], "rationale": "Cyclobenzaprine commonly causes dizziness/drowsiness and anticholinergic effects (e.g., dry mouth) and may contribute to muscle weakness; severe respiratory depression is not the most common adverse effect."}, {"id": 22, "type": "mc", "stem": "A client with heart failure asks for naproxen sodium for joint pain. Which is the best response?", "options": ["It is safe because it is an OTC medication.", "It can worsen heart failure due to sodium and fluid retention; ask the provider about alternatives.", "It is preferred over acetaminophen for heart failure.", "Take it on an empty stomach for best effect."], "answer": "It can worsen heart failure due to sodium and fluid retention; ask the provider about alternatives.", "rationale": "Many first‑generation NSAIDs (including naproxen sodium) can worsen hypertension/heart failure due to sodium content and fluid retention; alternatives may be safer."}, {"id": 23, "type": "mc", "stem": "A client is prescribed an oral medication known to undergo significant first‑pass metabolism. Which alternative route would best bypass first‑pass effect?", "options": ["Oral tablet", "Rectal suppository", "Sublingual administration", "Enteral feeding tube"], "answer": "Sublingual administration", "rationale": "Sublingual administration bypasses the GI tract and hepatic first‑pass metabolism via absorption through oral mucosa into systemic circulation."}, {"id": 24, "type": "mc", "stem": "A nurse is evaluating medication effectiveness. Which statement best describes efficacy?", "options": ["How quickly the medication begins to work", "The largest effect a medication can produce", "The amount of medication needed to produce an effect", "How much of the medication reaches the bloodstream"], "answer": "The largest effect a medication can produce", "rationale": "Efficacy refers to the maximal effect a drug can produce (height of the dose‑response curve)."}, {"id": 25, "type": "mc", "stem": "A nurse explains potency to a client comparing morphine to hydromorphone. Which statement is best?", "options": ["Potency describes the maximum effect the drug can produce.", "A more potent drug requires a smaller dose to produce a desired effect.", "Potency means the drug has fewer side effects.", "Potency is the same as bioavailability."], "answer": "A more potent drug requires a smaller dose to produce a desired effect.", "rationale": "Potency refers to the amount of drug required to produce an effect; higher potency means less drug is needed for the same effect."}, {"id": 26, "type": "sata", "stem": "A nurse is reviewing a medication list for potential risk of excessive free drug effect. Which conditions support this concern? Select all that apply.", "options": ["Albumin 2.0 g/dL", "Severe dehydration", "Normal liver function tests", "Advanced cirrhosis", "High-protein diet with albumin 4.5 g/dL"], "answer": ["Albumin 2.0 g/dL", "Advanced cirrhosis"], "rationale": "Low albumin—often from liver impairment or malnutrition—reduces protein binding, increasing free drug and risk for toxicity."}, {"id": 27, "type": "mc", "stem": "A client has status migrainosus lasting longer than 72 hours with poor oral intake. Which complication is the nurse most concerned about?", "options": ["Hyperkalemia from excess intake", "Fluid and electrolyte imbalance from dehydration", "Hypoglycemia from insulin overdose", "Respiratory depression from triptans"], "answer": "Fluid and electrolyte imbalance from dehydration", "rationale": "Migraines lasting >72 hours can impair hydration and nutrition, raising risk for dehydration and electrolyte imbalance."}, {"id": 28, "type": "calc", "stem": "A client received acetaminophen 1,000 mg at 0800, 1,000 mg at 1400, and 1,000 mg at 2000. The provider writes: “acetaminophen 650 mg PO now at 2300.” Using an adult max of 4,000 mg/24 hr, is it safe? (Answer Yes or No.)", "answer": ["Yes"], "rationale": "Total so far = 3,000 mg. Adding 650 mg = 3,650 mg in 24 hours, which is under 4,000 mg (assuming no liver disease/other combo products)."}, {"id": 29, "type": "mc", "stem": "Which opioid adverse effect is most important to anticipate and prevent in all clients receiving around‑the‑clock opioids?", "options": ["Constipation", "Miosis", "Pruritus", "Urinary retention"], "answer": "Constipation", "rationale": "Constipation is predictable with opioid therapy; prophylaxis (bowel regimen, fluids/fiber as appropriate) is standard. Other effects may occur but are not as universal."}, {"id": 30, "type": "mc", "stem": "A client taking oxycodone/APAP for pain asks why they must avoid other acetaminophen products. Best explanation?", "options": ["Because acetaminophen causes kidney failure first.", "Because combining products can exceed the safe daily maximum and cause hepatotoxicity.", "Because acetaminophen cancels the opioid effect.", "Because acetaminophen causes severe hypertension."], "answer": "Because combining products can exceed the safe daily maximum and cause hepatotoxicity.", "rationale": "Combination opioid/APAP products increase risk of accidental acetaminophen overdose leading to liver toxicity; clients must track total daily acetaminophen."}, {"id": 31, "type": "sata", "stem": "Which nursing assessments are most appropriate before administering a PRN opioid for severe pain? Select all that apply.", "options": ["Respiratory rate and oxygen saturation", "Level of consciousness/sedation level", "Pain assessment (location, quality, intensity, timing)", "Apical pulse for 1 full minute only", "Bowel sounds only"], "answer": ["Respiratory rate and oxygen saturation", "Level of consciousness/sedation level", "Pain assessment (location, quality, intensity, timing)"], "rationale": "Before giving opioids, assess pain and baseline respiratory/mental status to reduce risk for respiratory depression and oversedation."}, {"id": 32, "type": "mc", "stem": "A nurse is caring for a client receiving multiple medications. Which statement best defines pharmacokinetics?", "options": ["What the drug does to the body", "What the body does to the drug (ADME)", "The maximum effect a drug can produce", "The safest dose range of a drug"], "answer": "What the body does to the drug (ADME)", "rationale": "Pharmacokinetics describes absorption, distribution, metabolism, and excretion—what the body does to the drug."}, {"id": 33, "type": "mc", "stem": "A client has liver impairment with elevated ALT/AST and low albumin. Why is this clinically important for medication administration?", "options": ["The client will metabolize drugs faster and need higher doses.", "The client is at increased risk for drug toxicity due to delayed metabolism and more free drug.", "The client will excrete drugs faster via kidneys.", "The client will have fewer side effects from opioids."], "answer": "The client is at increased risk for drug toxicity due to delayed metabolism and more free drug.", "rationale": "Liver impairment can delay metabolism (prolonging half‑life) and reduce albumin (increasing free drug), both raising toxicity risk."}, {"id": 34, "type": "mc", "stem": "A nurse teaches about bioavailability. Which route has 100% bioavailability?", "options": ["Oral", "Intramuscular", "Intravenous", "Transdermal"], "answer": "Intravenous", "rationale": "IV administration delivers the entire dose directly into the bloodstream, giving 100% bioavailability."}, {"id": 35, "type": "mc", "stem": "A client with peripheral arterial disease has a toe infection. Which factor may reduce the effectiveness of antibiotics?", "options": ["Increased albumin levels", "Poor blood flow limiting distribution to the toe", "Increased gastric acid", "Rapid renal excretion"], "answer": "Poor blood flow limiting distribution to the toe", "rationale": "Distribution depends on adequate blood flow. Severe PAD can limit drug delivery to distal tissues like toes, reducing antibiotic effectiveness."}, {"id": 36, "type": "mc", "stem": "A nurse is caring for an older adult on multiple meds. Which age-related change increases risk for drug toxicity?", "options": ["Increased CYP activity", "Slower hepatic enzyme activity delaying metabolism", "Increased albumin production", "Increased renal clearance"], "answer": "Slower hepatic enzyme activity delaying metabolism", "rationale": "Geriatric enzyme systems slow, delaying metabolism and increasing toxicity risk; dosing may need adjustment."}, {"id": 37, "type": "mc", "stem": "Which description best matches therapeutic index?", "options": ["Time it takes for half the drug to be eliminated", "Comparison of therapeutic dose to toxic dose (safety)", "Amount of time to reach peak effect", "Percentage of drug that reaches the bloodstream"], "answer": "Comparison of therapeutic dose to toxic dose (safety)", "rationale": "Therapeutic index measures drug safety by comparing dose required for effect to dose that causes toxicity; narrow TI = higher toxicity risk."}, {"id": 38, "type": "sata", "stem": "Which medications/classes commonly warrant therapeutic drug monitoring due to narrow therapeutic index? Select all that apply.", "options": ["Certain anti-seizure (antiepileptic) medications", "Acetaminophen at normal doses", "Vancomycin (peak/trough in some cases)", "Topical lidocaine patches", "Some anticoagulants requiring lab monitoring"], "answer": ["Certain anti-seizure (antiepileptic) medications", "Vancomycin (peak/trough in some cases)", "Some anticoagulants requiring lab monitoring"], "rationale": "Narrow therapeutic index drugs often require monitoring to avoid toxicity—antiepileptics and some IV antibiotics (e.g., vancomycin) and certain anticoagulants with lab parameters are common examples."}, {"id": 39, "type": "mc", "stem": "A nurse is teaching a client about opioid safety at home. Which instruction is most important?", "options": ["Store opioids in an unlocked bathroom cabinet for easy access.", "Do not share the medication; keep it secured and dispose of leftovers properly.", "Take an extra dose if the pain returns within 30 minutes.", "Stop breathing exercises to avoid discomfort."], "answer": "Do not share the medication; keep it secured and dispose of leftovers properly.", "rationale": "Opioids should be secured, never shared, and disposed of safely to prevent misuse/overdose; extra doses increase risk for respiratory depression."}, {"id": 40, "type": "mc", "stem": "A client receiving naloxone begins vomiting and develops tachycardia. Which is the best nurse interpretation?", "options": ["Expected effects of naloxone; continue monitoring and provide supportive care.", "Allergic reaction; stop naloxone immediately.", "Indicates acetaminophen overdose.", "Indicates the opioid dose was too low."], "answer": "Expected effects of naloxone; continue monitoring and provide supportive care.", "rationale": "Naloxone can precipitate acute withdrawal-like symptoms (vomiting, tachycardia, hypertension, dysrhythmias). Monitor and manage airway/VS."}, {"id": 41, "type": "ordered", "stem": "A client reports new chest pain 10 minutes after taking sumatriptan. Place the nurse actions in priority order. (1 = first, 4 = last)", "steps": ["Stop further doses and assess vital signs and pain characteristics.", "Activate emergency response/notify provider and prepare for ECG per protocol.", "Place the client on oxygen if indicated and maintain IV access.", "Document findings and teaching about when to seek emergency care."], "answer_order": [1, 3, 2, 4], "rationale": "New chest pain after a triptan is concerning for coronary vasoconstriction/MI: assess immediately, support oxygenation/circulation, escalate care, and document/teach."}, {"id": 42, "type": "mc", "stem": "A client with suspected opioid toxicity is breathing 8/min. Which oxygen device is most appropriate to apply immediately while preparing further interventions?", "options": ["Nasal cannula at 1 L/min", "Venturi mask", "Non‑rebreather mask", "No oxygen; wait for naloxone"], "answer": "Non‑rebreather mask", "rationale": "In a respiratory emergency, provide high‑concentration oxygen (non‑rebreather) while addressing the underlying cause."}, {"id": 43, "type": "mc", "stem": "A nurse is deciding who to see first. Which client should be prioritized?", "options": ["Client requesting acetaminophen for a mild headache", "Client 1 hour post‑opioid with new confusion and RR 10/min", "Client with constipation after 3 days of opioids", "Client asking when the next dose of ibuprofen is due"], "answer": "Client 1 hour post‑opioid with new confusion and RR 10/min", "rationale": "Priority is the client with potential airway/breathing compromise and acute change in LOC after opioids."}, {"id": 44, "type": "sata", "stem": "A client is prescribed NSAIDs. Which findings/history increase risk for serious adverse effects? Select all that apply.", "options": ["History of gastrointestinal bleeding", "Heart failure", "Renal impairment", "Asthma", "Seasonal allergies only"], "answer": ["History of gastrointestinal bleeding", "Heart failure", "Renal impairment", "Asthma"], "rationale": "First‑generation NSAIDs can cause GI bleeding, worsen HF/HTN, worsen renal impairment, and may be contraindicated in asthma."}, {"id": 45, "type": "mc", "stem": "A nurse is preparing to administer ibuprofen. Which administration instruction is best to reduce GI irritation?", "options": ["Give with food or milk.", "Give only with water on an empty stomach.", "Crush and mix with grapefruit juice.", "Administer at bedtime only."], "answer": "Give with food or milk.", "rationale": "NSAIDs should be taken with food or milk to reduce gastric irritation and ulcer risk."}, {"id": 46, "type": "mc", "stem": "A client is receiving a medication that requires a trough level. When should the nurse plan to draw the trough?", "options": ["Immediately after the dose is infused", "Just before the next scheduled dose", "One hour after the next dose", "At the midpoint between doses"], "answer": "Just before the next scheduled dose", "rationale": "A trough is the lowest concentration and is drawn just before the next dose to guide dosing safely."}, {"id": 47, "type": "calc", "stem": "A medication has a half‑life of 8 hours. About how many hours until the drug is at its lowest concentration after stopping (≈5 half‑lives)? (Enter hours.)", "answer": ["40"], "rationale": "It takes ~5 half‑lives to reach minimal concentration after stopping: 5 × 8 = 40 hours."}, {"id": 48, "type": "mc", "stem": "A nurse reviews an order for aspirin for a 10‑year‑old with a viral illness. What is the best action?", "options": ["Administer as ordered.", "Question the order because aspirin is contraindicated in children.", "Give naproxen instead without notifying the provider.", "Give half the dose."], "answer": "Question the order because aspirin is contraindicated in children.", "rationale": "Aspirin is contraindicated in infants and children (risk of serious complications); the nurse should clarify the order."}, {"id": 49, "type": "mc", "stem": "A client says, “This drug is safer because it has a wide therapeutic window.” What does that mean?", "options": ["It is absorbed faster.", "There is a larger range between effective and toxic doses.", "It has a shorter half‑life.", "It is more potent."], "answer": "There is a larger range between effective and toxic doses.", "rationale": "A wide therapeutic window indicates a larger margin of safety between effective dose and toxic dose."}, {"id": 50, "type": "mc", "stem": "A nurse is reviewing a controlled substance prescription. Which agency regulates controlled substances in the U.S.?", "options": ["CDC", "DEA", "NIH", "OSHA"], "answer": "DEA", "rationale": "The Drug Enforcement Administration (DEA) enforces controlled substances laws and regulations."}];
const STORAGE_KEY = "nclex_painpharm_attempt_v1";

function defaultState(){
  return {
    startedAt: null,
    durationSec: 90*60,
    answers: {},
    flagged: {},
    submitted: false
  };
}

function loadState(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    return Object.assign(defaultState(), s);
  } catch(e) {
    return defaultState();
  }
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function resetState(){
  localStorage.removeItem(STORAGE_KEY);
  state = defaultState();
}

let state = loadState();
let currentIndex = 0;
let tickHandle = null;

function fmtTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec/60);
  const s = sec%60;
  return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}

function computeTimeLeft(){
  if(!state.startedAt) return state.durationSec;
  const elapsed = (Date.now() - state.startedAt)/1000;
  return state.durationSec - elapsed;
}

function answeredCount(){
  let c=0;
  for(const q of QUESTIONS){
    const a = state.answers[q.id];
    if(a==null) continue;
    if(q.type==="mc" && typeof a==="string" && a.trim()!=="") c++;
    else if(q.type==="calc" && typeof a==="string" && a.trim()!=="") c++;
    else if(q.type==="sata" && Array.isArray(a) && a.length>0) c++;
    else if(q.type==="ordered" && a && Array.isArray(a.order) && a.order.length===q.steps.length) c++;
  }
  return c;
}

function flaggedCount(){
  return Object.keys(state.flagged).length;
}

function isAnswered(q){
  const a = state.answers[q.id];
  if(a==null) return false;
  if(q.type==="mc" || q.type==="calc") return String(a).trim()!=="";
  if(q.type==="sata") return Array.isArray(a) && a.length>0;
  if(q.type==="ordered") return a && Array.isArray(a.order) && a.order.length===q.steps.length;
  return false;
}

function isCorrect(q){
  const a = state.answers[q.id];
  if(q.type==="calc"){
    const want = String(q.answer[0]).trim();
    const got = String(a ?? "").trim();
    const wantNum = Number(want);
    const gotNum = Number(got);
    if(!Number.isNaN(wantNum) && !Number.isNaN(gotNum)){
      return Math.abs(wantNum - gotNum) <= 0.001;
    }
    return got.toLowerCase() === want.toLowerCase();
  }
  if(q.type==="mc"){
    return String(a) === q.answer[0];
  }
  if(q.type==="sata"){
    const got = Array.isArray(a) ? a.slice().sort() : [];
    const want = q.answer.slice().sort();
    return JSON.stringify(got) === JSON.stringify(want);
  }
  if(q.type==="ordered"){
    const got = (a && Array.isArray(a.order)) ? a.order : [];
    const want = q.answer_order;
    return JSON.stringify(got) === JSON.stringify(want);
  }
  return false;
}

function buildNav(){
  const nav = document.getElementById("qnav");
  nav.innerHTML="";
  for(let i=0;i<QUESTIONS.length;i++){
    const q = QUESTIONS[i];
    const b = document.createElement("button");
    b.className="qbtn";
    b.textContent = String(i+1);
    b.addEventListener("click", ()=>{ currentIndex=i; render(); });
    nav.appendChild(b);
  }
}

function updateNavStyles(){
  const buttons = Array.from(document.querySelectorAll(".qbtn"));
  buttons.forEach((b, i)=>{
    const q = QUESTIONS[i];
    b.classList.toggle("active", i===currentIndex);
    b.classList.toggle("answered", isAnswered(q));
    b.classList.toggle("flagged", !!state.flagged[q.id]);
  });
}

function render(){
  const q = QUESTIONS[currentIndex];
  document.getElementById("headerTitle").textContent = `Question ${currentIndex+1}`;
  document.getElementById("curMeta").textContent = `${currentIndex+1} / ${QUESTIONS.length}`;
  document.getElementById("typeMeta").textContent = q.type.toUpperCase();
  document.getElementById("statusMeta").textContent = isAnswered(q) ? "Answered" : "Not answered";
  document.getElementById("qTag").textContent = ({
    mc:"Multiple Choice",
    sata:"Select all that apply (SATA)",
    ordered:"Ordered response",
    calc:"Calculation / short answer"
  })[q.type] || q.type;

  document.getElementById("stem").textContent = q.stem;

  const area = document.getElementById("interaction");
  area.innerHTML = "";

  if(q.type==="mc" || q.type==="sata"){
    const wrap = document.createElement("div");
    wrap.className="choices";
    const current = state.answers[q.id] ?? (q.type==="sata" ? [] : "");
    q.options.forEach((opt, idx)=>{
      const letter = String.fromCharCode(65+idx);
      const id = `q${q.id}_${letter}`;
      const lab = document.createElement("label");
      lab.className="choice";
      const inp = document.createElement("input");
      inp.type = (q.type==="mc") ? "radio" : "checkbox";
      inp.name = `q${q.id}`;
      inp.id = id;
      inp.value = letter;
      if(q.type==="mc"){
        inp.checked = (current === letter);
      } else {
        inp.checked = Array.isArray(current) && current.includes(letter);
      }
      inp.addEventListener("change", ()=>{
        if(q.type==="mc"){
          state.answers[q.id] = letter;
        } else {
          const arr = new Set(Array.isArray(state.answers[q.id]) ? state.answers[q.id] : []);
          if(inp.checked) arr.add(letter); else arr.delete(letter);
          state.answers[q.id] = Array.from(arr);
        }
        saveState();
        renderMeta();
        updateNavStyles();
      });

      const txt = document.createElement("div");
      txt.innerHTML = `<strong>${letter}.</strong> ${opt}`;
      lab.appendChild(inp);
      lab.appendChild(txt);
      wrap.appendChild(lab);
    });
    area.appendChild(wrap);
  }

  if(q.type==="calc"){
    const box = document.createElement("div");
    box.className="calcBox";
    const inp = document.createElement("input");
    inp.type="text";
    inp.placeholder="Type your answer (e.g., Yes, No, 3.125)";
    inp.value = state.answers[q.id] ?? "";
    inp.addEventListener("input", ()=>{
      state.answers[q.id] = inp.value;
      saveState();
      renderMeta();
      updateNavStyles();
    });
    box.appendChild(inp);
    const hint = document.createElement("div");
    hint.className="note";
    hint.textContent = "Tip: For numeric answers, enter a number (decimals allowed). For Yes/No, type Yes or No.";
    box.appendChild(hint);
    area.appendChild(box);
  }

  if(q.type==="ordered"){
    const ordWrap = document.createElement("div");
    ordWrap.className="ordered";
    let cur = state.answers[q.id]?.order;
    if(!Array.isArray(cur) || cur.length !== q.steps.length){
      cur = Array.from({length:q.steps.length}, (_,i)=> i+1);
      state.answers[q.id] = {order:cur};
      saveState();
    }
    function renderSteps(){
      ordWrap.innerHTML="";
      cur.forEach((stepNum, pos)=>{
        const row = document.createElement("div");
        row.className="step";
        const handle = document.createElement("div");
        handle.className="handle";
        handle.textContent = String(pos+1);
        const txt = document.createElement("div");
        txt.className="txt";
        txt.textContent = q.steps[stepNum-1];
        const arrows = document.createElement("div");
        arrows.className="arrows";
        const up = document.createElement("button");
        up.textContent = "▲";
        up.disabled = pos===0;
        up.addEventListener("click", ()=>{
          const t = cur[pos-1]; cur[pos-1]=cur[pos]; cur[pos]=t;
          state.answers[q.id] = {order:cur};
          saveState();
          renderSteps();
          renderMeta();
          updateNavStyles();
        });
        const dn = document.createElement("button");
        dn.textContent = "▼";
        dn.disabled = pos===cur.length-1;
        dn.addEventListener("click", ()=>{
          const t = cur[pos+1]; cur[pos+1]=cur[pos]; cur[pos]=t;
          state.answers[q.id] = {order:cur};
          saveState();
          renderSteps();
          renderMeta();
          updateNavStyles();
        });
        arrows.appendChild(up);
        arrows.appendChild(dn);
        row.appendChild(handle);
        row.appendChild(txt);
        row.appendChild(arrows);
        ordWrap.appendChild(row);
      });
      const note = document.createElement("div");
      note.className="note";
      note.textContent = "Use the arrows to place the actions in correct order.";
      ordWrap.appendChild(note);
    }
    renderSteps();
    area.appendChild(ordWrap);
  }

  document.getElementById("prevBtn").disabled = currentIndex===0;
  document.getElementById("nextBtn").disabled = currentIndex===QUESTIONS.length-1;

  updateNavStyles();
  renderMeta();
}

function renderMeta(){
  document.getElementById("answeredCount").textContent = answeredCount();
  document.getElementById("flaggedCount").textContent = flaggedCount();
  const q = QUESTIONS[currentIndex];
  document.getElementById("statusMeta").textContent = isAnswered(q) ? "Answered" : "Not answered";
}

function startTimer(){
  if(tickHandle) clearInterval(tickHandle);
  tickHandle = setInterval(()=>{
    const left = computeTimeLeft();
    document.getElementById("timer").textContent = fmtTime(left);
    if(left <= 0){
      clearInterval(tickHandle);
      tickHandle = null;
      submitExam(true);
    }
  }, 250);
}

function submitExam(auto=false){
  if(state.submitted) return;
  if(!auto){
    const ok = confirm("Submit now? You will see answers and rationales.");
    if(!ok) return;
  }
  state.submitted = true;
  saveState();

  let score=0;
  for(const q of QUESTIONS){
    if(isCorrect(q)) score++;
  }

  document.getElementById("exam").classList.add("hidden");
  document.getElementById("results").classList.remove("hidden");
  document.getElementById("scoreText").textContent = `${score}/${QUESTIONS.length}`;

  const body = document.getElementById("resultsBody");
  body.innerHTML = `<p class="note">Auto-grading note: SATA requires an exact match. Ordered response requires the exact sequence. Calculations accept a small numeric tolerance (plus case-insensitive Yes/No).</p>`;

  for(let i=0;i<QUESTIONS.length;i++){
    const q = QUESTIONS[i];
    const ok = isCorrect(q);
    const div = document.createElement("div");
    div.className="resultItem";
    const badge = `<span class="badge ${ok ? "ok":"no"}">${ok ? "Correct":"Incorrect"}</span>`;
    const your = state.answers[q.id];
    let yourTxt = "";
    let correctTxt = "";

    if(q.type==="mc"){
      yourTxt = your ? your : "(no answer)";
      correctTxt = q.answer[0];
    } else if(q.type==="sata"){
      yourTxt = (Array.isArray(your) && your.length) ? your.slice().sort().join(", ") : "(no answer)";
      correctTxt = q.answer.slice().sort().join(", ");
    } else if(q.type==="calc"){
      yourTxt = (your ?? "").toString().trim() || "(no answer)";
      correctTxt = q.answer[0];
    } else if(q.type==="ordered"){
      const y = (your && Array.isArray(your.order)) ? your.order.join("-") : "(no answer)";
      const c = q.answer_order.join("-");
      yourTxt = y;
      correctTxt = c;
    }

    div.innerHTML = `
      <div style="margin-bottom:6px;">
        ${badge}<strong>Q${i+1}.</strong> ${q.stem}
      </div>
      <div class="note"><strong>Your answer:</strong> ${yourTxt} &nbsp;&nbsp; <strong>Correct:</strong> ${correctTxt}</div>
      <div class="rationale"><strong>Rationale:</strong> ${q.rationale}</div>
    `;
    body.appendChild(div);
  }

  body.insertAdjacentHTML("beforeend", `
    <div class="controls" style="margin-top:16px;">
      <button class="btn ok" onclick="window.print()">Print / Save as PDF</button>
      <button class="btn" onclick="resetState(); location.reload();">Start New Attempt</button>
    </div>
  `);
}

document.getElementById("startBtn").addEventListener("click", ()=>{
  if(state.submitted){
    alert("This attempt is already submitted. Use 'Reset Saved Attempt' to start over.");
    return;
  }
  if(!state.startedAt){
    state.startedAt = Date.now();
    saveState();
  }
  document.getElementById("start").classList.add("hidden");
  document.getElementById("exam").classList.remove("hidden");
  buildNav();
  render();
  document.getElementById("timer").textContent = fmtTime(computeTimeLeft());
  startTimer();
});

document.getElementById("resetBtn").addEventListener("click", ()=>{
  const ok = confirm("Reset saved attempt? This clears answers and timer for this browser.");
  if(!ok) return;
  resetState();
  location.reload();
});

document.getElementById("prevBtn").addEventListener("click", ()=>{
  if(currentIndex>0) currentIndex--;
  render();
});
document.getElementById("nextBtn").addEventListener("click", ()=>{
  if(currentIndex<QUESTIONS.length-1) currentIndex++;
  render();
});
document.getElementById("flagBtn").addEventListener("click", ()=>{
  const q = QUESTIONS[currentIndex];
  if(state.flagged[q.id]) delete state.flagged[q.id];
  else state.flagged[q.id]=true;
  saveState();
  renderMeta();
  updateNavStyles();
});
document.getElementById("clearBtn").addEventListener("click", ()=>{
  const q = QUESTIONS[currentIndex];
  delete state.answers[q.id];
  if(q.type==="ordered"){
    state.answers[q.id] = {order: Array.from({length:q.steps.length}, (_,i)=> i+1)};
  }
  saveState();
  render();
});
document.getElementById("submitBtn").addEventListener("click", ()=> submitExam(false));

(function init(){
  if(state.submitted){
    document.getElementById("start").classList.add("hidden");
    document.getElementById("results").classList.remove("hidden");
    let score=0;
    for(const q of QUESTIONS) if(isCorrect(q)) score++;
    document.getElementById("scoreText").textContent = `${score}/${QUESTIONS.length}`;
    const body = document.getElementById("resultsBody");
    body.innerHTML = `<p class="note">This attempt was already submitted on this browser.</p>`;
    for(let i=0;i<QUESTIONS.length;i++){
      const q = QUESTIONS[i];
      const ok = isCorrect(q);
      const div = document.createElement("div");
      div.className="resultItem";
      const badge = `<span class="badge ${ok ? "ok":"no"}">${ok ? "Correct":"Incorrect"}</span>`;
      const your = state.answers[q.id];
      let yourTxt="", correctTxt="";
      if(q.type==="mc"){ yourTxt = your ? your : "(no answer)"; correctTxt=q.answer[0]; }
      else if(q.type==="sata"){ yourTxt=(Array.isArray(your)&&your.length)?your.slice().sort().join(", "):"(no answer)"; correctTxt=q.answer.slice().sort().join(", "); }
      else if(q.type==="calc"){ yourTxt=(your??"").toString().trim()||"(no answer)"; correctTxt=q.answer[0]; }
      else if(q.type==="ordered"){ yourTxt=(your&&Array.isArray(your.order))?your.order.join("-"):"(no answer)"; correctTxt=q.answer_order.join("-"); }
      div.innerHTML = `<div style="margin-bottom:6px;">${badge}<strong>Q${i+1}.</strong> ${q.stem}</div>
        <div class="note"><strong>Your answer:</strong> ${yourTxt} &nbsp;&nbsp; <strong>Correct:</strong> ${correctTxt}</div>
        <div class="rationale"><strong>Rationale:</strong> ${q.rationale}</div>`;
      body.appendChild(div);
    }
    body.insertAdjacentHTML("beforeend", `
      <div class="controls" style="margin-top:16px;">
        <button class="btn ok" onclick="window.print()">Print / Save as PDF</button>
        <button class="btn" onclick="resetState(); location.reload();">Start New Attempt</button>
      </div>
    `);
    return;
  }

  if(state.startedAt){
    document.getElementById("start").classList.add("hidden");
    document.getElementById("exam").classList.remove("hidden");
    buildNav();
    render();
    document.getElementById("timer").textContent = fmtTime(computeTimeLeft());
    startTimer();
  }
})();
</script>
</body>
</html>
